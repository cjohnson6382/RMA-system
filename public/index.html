<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>React Tutorial</title>
    <!-- Not present in the tutorial. Just for basic styling. -->
    <link rel="stylesheet" href="css/base.css" />
    <script src="https://unpkg.com/react@15.3.0/dist/react.js"></script>
    <script src="https://unpkg.com/react-dom@15.3.0/dist/react-dom.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <script src="https://unpkg.com/jquery@3.1.0/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/remarkable@1.6.2/dist/remarkable.min.js"></script>
  </head>
  <body>
    <div id="content"></div>
    <!-- <script type="text/babel" src="scripts/example.js"></script> -->
    <script type="text/babel">
        // tutorial.js
        
        const CommentBox = React.createClass({
            handleCommentSubmit: function (comment) {
            
                $.post(this.props.url, comment, function (data) {
                    this.setState({ data: data });
                }.bind(this));
            },
            getInitialState: function () {
                return { data: [] };
            },
            
            loadCommentsFromServer: function () {
                $.get(this.props.source, function (data) {
                    this.setState({ data: data });
                }.bind(this));                

            },
            
            componentDidMount: function () {
                this.loadCommentsFromServer();
                setInterval(this.loadCommentsFromServer, this.props.pollInterval);
            },
        
            render: function () {
                return (
                    <div className="commentBox">
                        Hellooooo world
                        <h1>Comments</h1>
                        <CommentList data={ this.state.data } />
                        <CommentForm onCommentSubmit={ this.handleCommentSubmit } />
                    </div>
                );
            }
        });
        
        const CommentList = React.createClass({
            render: function () {
                const commentNodes = this.props.data.map(function (comment) {
                    return (
                        <Comment author={comment.author} key={comment.id}>
                            {comment.text}
                        </Comment>
                    );
                });
                
                return (
                    <div className="commentList">
                        {commentNodes}
                    </div>
                );
            }
        });
        
        const CommentForm = React.createClass({
            getInitialState: function () {
                return {author: '', text: ''};
            },
        
            handleAuthorChange: function (e) {
                this.setState({ author: e.target.value });
            },
            
            handleCommentChange: function (e) {
                this.setState({ text: e.target.value });
            },
        
            handleSubmit: function (e) {
                //  browser's default action is to actually submit the form, which we don't want
                e.preventDefault();
                
                const author = this.state.author.trim();
                const text = this.state.text.trim();
                
                if (!text || !author) {
                    return;
                }
                
                this.props.onCommentSubmit({ author: author, text: text });
                //  clear the form
                this.setState({ author: '', text: ''});
            },
        
            render: function () {
                return (
                    <h3>Add a new comment</h3>
                    <form className="commentForm" onSubmit={this.handleSubmit} >
                        <input type="text" placeholder="Name" value={this.state.author} onChange={this.handleAuthorChange} />
                        <input type="text" placeholder="Comment" value={this.state.text} onChange={this.handleCommentChange} />
                        <input type="submit" value="Post" />
                    </form>
                );
            }
        });
        
        const Comment = React.createClass({
            rawMarkup: function () {
                const md = new Remarkable();
                const rawMarkup = md.render(this.props.children.toString());
                return { __html: rawMarkup };
            },

            render: function () {
                return (
                    <div className="comment">
                        <h2 className="commentAuthor">
                            {this.props.author}
                        </h2>
                        <span dangerouslySetInnerHTML = {this.rawMarkup() }/>
                    </div>
                );
            }
        });
        
        ReactDOM.render(
            <CommentBox source="http://cjohnson.ignorelist.com/api/comments" pollInterval={2000}/>,
            document.getElementById('content')
        );
    </script>
  </body>
</html>
